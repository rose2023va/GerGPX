<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Iceland Swim Map - Satellite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin:0; display:flex; font-family:Arial,sans-serif; }
    #filters { width:260px; padding:16px; background:#fff; border-right:1px solid #ddd; overflow-y:auto; height:100vh; }
    #map { flex:1; height:100vh; }
    .filter-item{ margin:8px 0; }
    button{ margin-right:6px; }
  </style>
</head>
<body>
  <div id="filters">
    <h3>Swim Legs</h3>
    <div id="checkboxes"></div>
    <button onclick="showAll()">Show All</button>
    <button onclick="clearAll()">Clear All</button>
  </div>
  <div id="map"></div>

  <!-- Libs -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <!-- Data loader (fetches CSV from Google Sheets) -->
  <script src="swim-legs.js"></script>

  <script>
    // --- 1) Create the map (declare ONCE) ---
    const map = L.map('map', { center:[64.9631,-19.0208], zoom:6, zoomControl:true });

    // Satellite base
    L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { attribution: 'Tiles © Esri — USGS, NOAA', maxZoom: 18 }
    ).addTo(map);

    // --- 2) Helpers & state ---
    const legLayers = {};
    const bounds = L.latLngBounds();
    const listEl = document.getElementById('checkboxes');

    function parseLatLon(pair){
      if(!pair) return null;
      const [lat, lon] = String(pair).split(',').map(s => Number(s.trim()));
      if(Number.isNaN(lat) || Number.isNaN(lon)) return null;
      return [lat, lon]; // sheet is lat,lon
    }

    function addLegRow(name){
      const row = document.createElement('div');
      row.className = 'filter-item';
      row.innerHTML = `
        <label>
          <input type="checkbox" checked onchange="toggleLeg('${name.replace(/'/g,"&#39;")}', this.checked)">
          ${name}
        </label>`;
      listEl.appendChild(row);
    }

    // --- 3) Render after CSV loads ---
    <!-- --- 3) Render after CSV loads (sorted) --- -->
<script>
  // helper: parse lat,lon string
  function parseLatLon(pair){
    if(!pair) return null;
    const [lat, lon] = String(pair).split(',').map(s => Number(s.trim()));
    if(Number.isNaN(lat) || Number.isNaN(lon)) return null;
    return [lat, lon];
  }

  // helper: build UTC date from row (handles missing time)
  function toUtcDate(row){
    const d = (row.start_date || '').trim();
    const t = (row.start_time || '00:00:00').trim();
    if(!d) return null;
    const iso = `${d}T${t.endsWith('Z') ? t : t + 'Z'}`; // assume UTC
    const ms = Date.parse(iso);
    return Number.isNaN(ms) ? null : new Date(ms);
  }

  // helper: angle from a center (for spatial sort fallback)
  const CENTER = { lat: 64.9631, lon: -19.0208 }; // Iceland
  function angleFromCenter(lat, lon){
    const ang = Math.atan2(lat - CENTER.lat, lon - CENTER.lon); // radians
    let deg = ang * 180 / Math.PI;         // [-180,180]
    if (deg < 0) deg += 360;               // [0,360)
    return deg;
  }

  loadSwimLegs().then(allRows => {
    // sort rows: time asc if present, else by angle around island
    const rows = [...allRows].sort((a,b) => {
      const aStart = parseLatLon(a.start_coordinates);
      const bStart = parseLatLon(b.start_coordinates);

      const aDt = toUtcDate(a);
      const bDt = toUtcDate(b);

      if (aDt && bDt) return aDt - bDt;              // chronological
      if (aDt && !bDt) return -1;
      if (!aDt && bDt) return 1;

      // fallback: spatial order
      if (aStart && bStart) {
        const aAng = angleFromCenter(aStart[0], aStart[1]);
        const bAng = angleFromCenter(bStart[0], bStart[1]);
        return aAng - bAng;                           // clockwise
      }
      return 0;
    });

    rows.forEach((r, idx) => {
      const start = parseLatLon(r.start_coordinates);
      const end   = parseLatLon(r.end_coordinates);
      if(!start || !end) return;

      const name = (r.filename && r.filename.trim()) || `Leg ${idx+1}`;

      const line = L.polyline([start, end], { color:'red', weight:4, opacity:0.9 })
        .bindPopup(
          `<strong>${name}</strong><br>
           ${r.start_date||''} ${r.start_time||''} → ${r.finish_date||''} ${r.end_time||''}<br>
           <small>Start: ${r.start_coordinates}<br>End: ${r.end_coordinates}</small>`
        )
        .addTo(map);

      legLayers[name] = line;
      bounds.extend(line.getBounds());

      const row = document.createElement('div');
      row.className = 'filter-item';
      row.innerHTML = `
        <label>
          <input type="checkbox" checked onchange="toggleLeg('${name.replace(/'/g,"&#39;")}', this.checked)">
          ${name}
        </label>`;
      listEl.appendChild(row);
    });

    if(bounds.isValid()) map.fitBounds(bounds.pad(0.1));
    else console.warn('No lines drawn. Check CSV field names and coordinate format.');
  }).catch(err => {
    console.error('Failed to load swim legs:', err);
    alert('Could not load swim legs. Open console for details.');
  });
    // --- 4) UI controls ---
    window.toggleLeg = function(id, show){
      const layer = legLayers[id];
      if(!layer) return;
      if(show) layer.addTo(map); else map.removeLayer(layer);
    };
    window.showAll = function(){
      Object.keys(legLayers).forEach(id => {
        legLayers[id].addTo(map);
        const input = [...document.querySelectorAll('#checkboxes input')].find(i => i.nextSibling.nodeValue.trim()===id);
        if(input) input.checked = true;
      });
    };
    window.clearAll = function(){
      Object.keys(legLayers).forEach(id => {
        map.removeLayer(legLayers[id]);
        const input = [...document.querySelectorAll('#checkboxes input')].find(i => i.nextSibling.nodeValue.trim()===id);
        if(input) input.checked = false;
      });
    };
  </script>
</body>
</html>
